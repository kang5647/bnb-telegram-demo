import{r as h,cQ as g,cR as b,cS as G,cT as y,cU as H,cV as Q,cW as L,cX as X,cY as Y,cZ as Z,c_ as z,bR as q}from"./index-BskVN1uw.js";import{L as J}from"./throttle-DmyeiLyN.js";import{u as T}from"./index-pivhCTIm.js";var K=function(e){return function(r,n){var t=h.useRef(!1);e(function(){return function(){t.current=!1}},[]),e(function(){if(!t.current)t.current=!0;else return r()},n)}};const B=K(h.useEffect);var $=function(e,r){var n=r.manual,t=r.ready,u=t===void 0?!0:t,a=r.defaultParams,o=a===void 0?[]:a,c=r.refreshDeps,s=c===void 0?[]:c,i=r.refreshDepsAction,v=h.useRef(!1);return v.current=!1,B(function(){!n&&u&&(v.current=!0,e.run.apply(e,g([],b(o),!1)))},[u]),B(function(){v.current||n||(v.current=!0,i?i():e.refresh())},g([],b(s),!1)),{onBefore:function(){if(!u)return{stopNow:!0}}}};$.onInit=function(e){var r=e.ready,n=r===void 0?!0:r,t=e.manual;return{loading:!t&&n}};function V(e,r){var n=h.useRef({deps:r,obj:void 0,initialized:!1}).current;return(n.initialized===!1||!G(n.deps,r))&&(n.deps=r,n.obj=e(),n.initialized=!0),n.obj}var D=new Map,I=function(e,r,n){var t=D.get(e);t!=null&&t.timer&&clearTimeout(t.timer);var u=void 0;r>-1&&(u=setTimeout(function(){D.delete(e)},r)),D.set(e,y(y({},n),{timer:u}))},k=function(e){return D.get(e)},F=new Map,ee=function(e){return F.get(e)},ne=function(e,r){F.set(e,r),r.then(function(n){return F.delete(e),n}).catch(function(){F.delete(e)})},w={},re=function(e,r){w[e]&&w[e].forEach(function(n){return n(r)})},x=function(e,r){return w[e]||(w[e]=[]),w[e].push(r),function(){var t=w[e].indexOf(r);w[e].splice(t,1)}},te=function(e,r){var n=r.cacheKey,t=r.cacheTime,u=t===void 0?5*60*1e3:t,a=r.staleTime,o=a===void 0?0:a,c=r.setCache,s=r.getCache,i=h.useRef(),v=h.useRef(),d=function(f,l){c?c(l):I(f,u,l),re(f,l.data)},m=function(f,l){return l===void 0&&(l=[]),s?s(l):k(f)};return V(function(){if(n){var f=m(n);f&&Object.hasOwnProperty.call(f,"data")&&(e.state.data=f.data,e.state.params=f.params,(o===-1||new Date().getTime()-f.time<=o)&&(e.state.loading=!1)),i.current=x(n,function(l){e.setState({data:l})})}},[]),H(function(){var f;(f=i.current)===null||f===void 0||f.call(i)}),n?{onBefore:function(f){var l=m(n,f);return!l||!Object.hasOwnProperty.call(l,"data")?{}:o===-1||new Date().getTime()-l.time<=o?{loading:!1,data:l==null?void 0:l.data,error:void 0,returnNow:!0}:{data:l==null?void 0:l.data,error:void 0}},onRequest:function(f,l){var p=ee(n);return p&&p!==v.current?{servicePromise:p}:(p=f.apply(void 0,g([],b(l),!1)),v.current=p,ne(n,p),{servicePromise:p})},onSuccess:function(f,l){var p;n&&((p=i.current)===null||p===void 0||p.call(i),d(n,{data:f,params:l,time:new Date().getTime()}),i.current=x(n,function(A){e.setState({data:A})}))},onMutate:function(f){var l;n&&((l=i.current)===null||l===void 0||l.call(i),d(n,{data:f,params:e.state.params,time:new Date().getTime()}),i.current=x(n,function(p){e.setState({data:p})}))}}:{}},ie=function(e,r){var n=r.debounceWait,t=r.debounceLeading,u=r.debounceTrailing,a=r.debounceMaxWait,o=h.useRef(),c=h.useMemo(function(){var s={};return t!==void 0&&(s.leading=t),u!==void 0&&(s.trailing=u),a!==void 0&&(s.maxWait=a),s},[t,u,a]);return h.useEffect(function(){if(n){var s=e.runAsync.bind(e);return o.current=Q(function(i){i()},n,c),e.runAsync=function(){for(var i=[],v=0;v<arguments.length;v++)i[v]=arguments[v];return new Promise(function(d,m){var f;(f=o.current)===null||f===void 0||f.call(o,function(){s.apply(void 0,g([],b(i),!1)).then(d).catch(m)})})},function(){var i;(i=o.current)===null||i===void 0||i.cancel(),e.runAsync=s}}},[n,c]),n?{onCancel:function(){var s;(s=o.current)===null||s===void 0||s.cancel()}}:{}},ue=function(e,r){var n=r.loadingDelay,t=r.ready,u=h.useRef();if(!n)return{};var a=function(){u.current&&clearTimeout(u.current)};return{onBefore:function(){return a(),t!==!1&&(u.current=setTimeout(function(){e.setState({loading:!0})},n)),{loading:!1}},onFinally:function(){a()},onCancel:function(){a()}}};function j(){return L?document.visibilityState!=="hidden":!0}var S=[];function ae(e){return S.push(e),function(){var n=S.indexOf(e);S.splice(n,1)}}if(L){var oe=function(){if(j())for(var e=0;e<S.length;e++){var r=S[e];r()}};window.addEventListener("visibilitychange",oe,!1)}var se=function(e,r){var n=r.pollingInterval,t=r.pollingWhenHidden,u=t===void 0?!0:t,a=r.pollingErrorRetryCount,o=a===void 0?-1:a,c=h.useRef(),s=h.useRef(),i=h.useRef(0),v=function(){var d;c.current&&clearTimeout(c.current),(d=s.current)===null||d===void 0||d.call(s)};return B(function(){n||v()},[n]),n?{onBefore:function(){v()},onError:function(){i.current+=1},onSuccess:function(){i.current=0},onFinally:function(){o===-1||o!==-1&&i.current<=o?c.current=setTimeout(function(){!u&&!j()?s.current=ae(function(){e.refresh()}):e.refresh()},n):i.current=0},onCancel:function(){v()}}:{}};function ce(e,r){var n=!1;return function(){for(var t=[],u=0;u<arguments.length;u++)t[u]=arguments[u];n||(n=!0,e.apply(void 0,g([],b(t),!1)),setTimeout(function(){n=!1},r))}}function fe(){return L&&typeof navigator.onLine<"u"?navigator.onLine:!0}var E=[];function le(e){return E.push(e),function(){var n=E.indexOf(e);n>-1&&E.splice(n,1)}}if(L){var U=function(){if(!(!j()||!fe()))for(var e=0;e<E.length;e++){var r=E[e];r()}};window.addEventListener("visibilitychange",U,!1),window.addEventListener("focus",U,!1)}var de=function(e,r){var n=r.refreshOnWindowFocus,t=r.focusTimespan,u=t===void 0?5e3:t,a=h.useRef(),o=function(){var c;(c=a.current)===null||c===void 0||c.call(a)};return h.useEffect(function(){if(n){var c=ce(e.refresh.bind(e),u);a.current=le(function(){c()})}return function(){o()}},[n,u]),H(function(){o()}),{}},ve=function(e,r){var n=r.retryInterval,t=r.retryCount,u=h.useRef(),a=h.useRef(0),o=h.useRef(!1);return t?{onBefore:function(){o.current||(a.current=0),o.current=!1,u.current&&clearTimeout(u.current)},onSuccess:function(){a.current=0},onError:function(){if(a.current+=1,t===-1||a.current<=t){var c=n??Math.min(1e3*Math.pow(2,a.current),3e4);u.current=setTimeout(function(){o.current=!0,e.refresh()},c)}else a.current=0},onCancel:function(){a.current=0,u.current&&clearTimeout(u.current)}}:{}},he=function(e,r){var n=r.throttleWait,t=r.throttleLeading,u=r.throttleTrailing,a=h.useRef(),o={};return t!==void 0&&(o.leading=t),u!==void 0&&(o.trailing=u),h.useEffect(function(){if(n){var c=e.runAsync.bind(e);return a.current=J(function(s){s()},n,o),e.runAsync=function(){for(var s=[],i=0;i<arguments.length;i++)s[i]=arguments[i];return new Promise(function(v,d){var m;(m=a.current)===null||m===void 0||m.call(a,function(){c.apply(void 0,g([],b(s),!1)).then(v).catch(d)})})},function(){var s;e.runAsync=c,(s=a.current)===null||s===void 0||s.cancel()}}},[n,t,u]),n?{onCancel:function(){var c;(c=a.current)===null||c===void 0||c.cancel()}}:{}},me=function(e){h.useEffect(function(){e==null||e()},[])},pe=function(){var e=b(h.useState({}),2),r=e[1];return h.useCallback(function(){return r({})},[])},ge=function(){function e(r,n,t,u){u===void 0&&(u={}),this.serviceRef=r,this.options=n,this.subscribe=t,this.initState=u,this.count=0,this.state={loading:!1,params:void 0,data:void 0,error:void 0},this.state=y(y(y({},this.state),{loading:!n.manual}),u)}return e.prototype.setState=function(r){r===void 0&&(r={}),this.state=y(y({},this.state),r),this.subscribe()},e.prototype.runPluginHandler=function(r){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];var u=this.pluginImpls.map(function(a){var o;return(o=a[r])===null||o===void 0?void 0:o.call.apply(o,g([a],b(n),!1))}).filter(Boolean);return Object.assign.apply(Object,g([{}],b(u),!1))},e.prototype.runAsync=function(){for(var r,n,t,u,a,o,c,s,i,v,d=[],m=0;m<arguments.length;m++)d[m]=arguments[m];return X(this,void 0,void 0,function(){var f,l,p,A,W,_,M,O,R,P,N;return Z(this,function(C){switch(C.label){case 0:if(this.count+=1,f=this.count,l=this.runPluginHandler("onBefore",d),p=l.stopNow,A=p===void 0?!1:p,W=l.returnNow,_=W===void 0?!1:W,M=z(l,["stopNow","returnNow"]),A)return[2,new Promise(function(){})];if(this.setState(y({loading:!0,params:d},M)),_)return[2,Promise.resolve(M.data)];(n=(r=this.options).onBefore)===null||n===void 0||n.call(r,d),C.label=1;case 1:return C.trys.push([1,3,,4]),O=this.runPluginHandler("onRequest",this.serviceRef.current,d).servicePromise,O||(O=(N=this.serviceRef).current.apply(N,g([],b(d),!1))),[4,O];case 2:return R=C.sent(),f!==this.count?[2,new Promise(function(){})]:(this.setState({data:R,error:void 0,loading:!1}),(u=(t=this.options).onSuccess)===null||u===void 0||u.call(t,R,d),this.runPluginHandler("onSuccess",R,d),(o=(a=this.options).onFinally)===null||o===void 0||o.call(a,d,R,void 0),f===this.count&&this.runPluginHandler("onFinally",d,R,void 0),[2,R]);case 3:if(P=C.sent(),f!==this.count)return[2,new Promise(function(){})];throw this.setState({error:P,loading:!1}),(s=(c=this.options).onError)===null||s===void 0||s.call(c,P,d),this.runPluginHandler("onError",P,d),(v=(i=this.options).onFinally)===null||v===void 0||v.call(i,d,void 0,P),f===this.count&&this.runPluginHandler("onFinally",d,void 0,P),P;case 4:return[2]}})})},e.prototype.run=function(){for(var r=this,n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];this.runAsync.apply(this,g([],b(n),!1)).catch(function(u){r.options.onError||console.error(u)})},e.prototype.cancel=function(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")},e.prototype.refresh=function(){this.run.apply(this,g([],b(this.state.params||[]),!1))},e.prototype.refreshAsync=function(){return this.runAsync.apply(this,g([],b(this.state.params||[]),!1))},e.prototype.mutate=function(r){var n=Y(r)?r(this.state.data):r;this.runPluginHandler("onMutate",n),this.setState({data:n})},e}();function be(e,r,n){r===void 0&&(r={}),n===void 0&&(n=[]);var t=r.manual,u=t===void 0?!1:t,a=z(r,["manual"]),o=y({manual:u},a),c=q(e),s=pe(),i=V(function(){var v=n.map(function(d){var m;return(m=d==null?void 0:d.onInit)===null||m===void 0?void 0:m.call(d,o)}).filter(Boolean);return new ge(c,o,s,Object.assign.apply(Object,g([{}],b(v),!1)))},[]);return i.options=o,i.pluginImpls=n.map(function(v){return v(i,o)}),me(function(){if(!u){var v=i.state.params||r.defaultParams||[];i.run.apply(i,g([],b(v),!1))}}),H(function(){i.cancel()}),{loading:i.state.loading,data:i.state.data,error:i.state.error,params:i.state.params||[],cancel:T(i.cancel.bind(i)),refresh:T(i.refresh.bind(i)),refreshAsync:T(i.refreshAsync.bind(i)),run:T(i.run.bind(i)),runAsync:T(i.runAsync.bind(i)),mutate:T(i.mutate.bind(i))}}function we(e,r,n){return be(e,r,g(g([],b([]),!1),[ie,ue,se,de,he,$,te,ve],!1))}export{we as u};
